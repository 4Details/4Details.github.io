---
title: 讨论社区41  -  任务执行和调度
date: 2019-08-20 21:43:15
tags: [线程池]
category: [讨论社区项目]
---

### JDK线程池

- ExecutorService
- ScheduledExecutorService(可以执行定时任务)

没有解决分布式部署的问题

```java
// JDK普通线程池
private ExecutorService executorService = Executors.newFixedThreadPool(5);

// JDK可执行定时任务的线程池
private ScheduledExecutorService scheduledExecutorService = Executors.newScheduledThreadPool(5);

// 1. JDK 普通线程池
@Test
public void testExecutorService(){
	Runnable task = new Runnable() {
		@Override
		public void run() {
			logger.debug("hello ExecutorService");
		}
	};
	for (int i = 0; i < 10; i++) {
	executorService.submit(task);
	}
	sleep(10000);
	}

// 2.JDK可执行定时任务的线程池
@Test
public void testScheduledExecutorService(){
	Runnable task = new Runnable() {
		@Override
		public void run() {
			logger.debug("hello ScheduledExecutorService");
		}
	};

	scheduledExecutorService.scheduleAtFixedRate(task, 10000, 1000, TimeUnit.MILLISECONDS);

	sleep(10000);
}
```



### Spring 线程池

- ThreadPoolTaskExecutor
- ThreadPoolTaskScheduler（分布式环境可能出问题）

正常版

```java
// 3. Spring 普通线程池
@Test
public void testThreadPoolExecutor(){
    Runnable task = new Runnable() {
        @Override
        public void run() {
            logger.debug("hello ThreadPoolExecutor");
        }
    };
    for (int i = 0; i < 10; i++) {
        threadPoolExecutor.submit(task);
    }
    sleep(10000);
}

// 4. Spring 可执行定时任务的线程池
@Test
public void testThreadPoolTaskScheduler(){
    Runnable task = new Runnable() {
        @Override
        public void run() {
            logger.debug("hello ThreadPoolTaskScheduler");
        }
    };
    Date date = new Date(System.currentTimeMillis()+10000);
    threadPoolTaskScheduler.scheduleAtFixedRate(task, date, 1000);

    sleep(10000);
}
```

简化版

```java
//service中定义
// 让该方法在多线程环境下,被异步的调用.
@Async
public void execute1() {
	logger.debug("execute1");
}

@Scheduled(initialDelay = 10000, fixedRate = 1000)
public void execute2() {
	logger.debug("execute2");
}
```

```java
// 5.Spring普通线程池(简化)
@Test
public void testThreadPoolTaskExecutorSimple() {
    for (int i = 0; i < 10; i++) {
        alphaService.execute1();
    }

    sleep(10000);
}

// 6.Spring定时任务线程池(简化)
@Test
public void testThreadPoolTaskSchedulerSimple() {
     sleep(30000);
}
```



### 分布式定时任务

http://www.quartz-scheduler.org

- Spring Quartz（将数据存储到数据库，分布式时可以共享数据）

  ```xml
  <dependency>
      <groupId>org.springframework.boot</groupId>
      <artifactId>spring-boot-starter-quartz</artifactId>
  </dependency>
  ```

  导入包之后还需要在数据库导入对应的表，可从[Quartz-Github](https://github.com/quartz-scheduler/quartz/tree/9f9e400733f51f7cb658e3319fc2c140ab8af938/quartz-core/src/main/resources/org/quartz/impl/jdbcjobstore)根据数据库类型选择下载。

  - 核心调度接口Scheduler
  - 定义任务的接口Job的execute方法
  - Jobdetail接口来配置Job的名字、组等
  - Trigger接口配置Job的什么时候运行、运行频率
  - QuartzConfig：配置 -> 数据库 -> 调用

  ```java
  import com.wx.talking.quartz.AlphaJob;
  import com.wx.talking.quartz.PostScoreRefreshJob;
  import org.quartz.JobDataMap;
  import org.quartz.JobDetail;
  import org.springframework.context.annotation.Bean;
  import org.springframework.context.annotation.Configuration;
  import org.springframework.scheduling.quartz.JobDetailFactoryBean;
  import org.springframework.scheduling.quartz.SimpleTriggerFactoryBean;
  
  // 配置 -> 数据库 -> 调用   //进第一次配置初始化到数据库
  @Configuration
  public class QuartzConfig {
  
      // FactoryBean可简化Bean的实例化过程:
      // 1.通过FactoryBean封装Bean的实例化过程.
      // 2.将FactoryBean装配到Spring容器里.
      // 3.将FactoryBean注入给其他的Bean.
      // 4.该Bean得到的是FactoryBean所管理的对象实例.
  
      // 配置JobDetail
      // @Bean
      public JobDetailFactoryBean alphaJobDetail() {
          JobDetailFactoryBean factoryBean = new JobDetailFactoryBean();
          factoryBean.setJobClass(AlphaJob.class);
          factoryBean.setName("alphaJob");
          factoryBean.setGroup("alphaJobGroup");
          factoryBean.setDurability(true); // 设置任务是否持久保存
          factoryBean.setRequestsRecovery(true); // 任务是否可恢复
          return factoryBean;
      }
  
      // 配置Trigger(SimpleTriggerFactoryBean, CronTriggerFactoryBean)
      // @Bean
      public SimpleTriggerFactoryBean alphaTrigger(JobDetail alphaJobDetail) {
          SimpleTriggerFactoryBean factoryBean = new SimpleTriggerFactoryBean();
          factoryBean.setJobDetail(alphaJobDetail);
          factoryBean.setName("alphaTrigger");
          factoryBean.setGroup("alphaTriggerGroup");
          factoryBean.setRepeatInterval(3000);
          factoryBean.setJobDataMap(new JobDataMap());
          return factoryBean;
      }
  }
  
  ```

- FactoryBean可简化Bean的实例化过程:
  1. 通过FactoryBean封装Bean的实例化过程
  2. 将FactoryBean装配到Spring容器里
  3. 将FactoryBean注入给其他的Bean.
  4. 该Bean得到的是FactoryBean所管理的对象实例.

